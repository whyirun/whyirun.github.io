<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Why I Run — Editor</title>
<style>
:root {
  --bg: #f5f5f0;
  --surface: #ffffff;
  --border: #e2e2dd;
  --border-focus: #3b82f6;
  --text: #1a1a1a;
  --text-muted: #6b7280;
  --primary: #3b82f6;
  --primary-hover: #2563eb;
  --danger: #ef4444;
  --success: #10b981;
  --toolbar-h: 56px;
  --colheader-h: 38px;
  --row-h: calc(50vh - 52px);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

/* Toolbar */
#toolbar { height: var(--toolbar-h); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: #1a1a1a; color: #fff; gap: 12px; z-index: 100; }
#toolbar h1 { font-size: 16px; font-weight: 600; white-space: nowrap; }
#toolbar .actions { display: flex; align-items: center; gap: 8px; }
#toolbar input[type="text"] { padding: 6px 12px; border-radius: 6px; border: 1px solid #444; background: #2a2a2a; color: #fff; font-size: 13px; width: 180px; outline: none; }
#toolbar input[type="text"]:focus { border-color: var(--primary); }
#toolbar input[type="text"]::placeholder { color: #888; }
.btn { padding: 6px 14px; border-radius: 6px; border: none; font-size: 13px; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; transition: all 0.15s; }
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { background: var(--primary-hover); }
.btn-ghost { background: transparent; color: #ccc; border: 1px solid #444; }
.btn-ghost:hover { background: #333; color: #fff; }
.btn-danger { background: var(--danger); color: #fff; }
.btn-danger:hover { background: #dc2626; }
.btn-success { background: var(--success); color: #fff; }
.btn-success:hover { background: #059669; }
.version-badge { background: #374151; color: #9ca3af; font-size: 11px; padding: 3px 8px; border-radius: 10px; margin-left: 4px; }

/* Toast */
#toast-container { position: fixed; top: 66px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
.toast { padding: 10px 18px; border-radius: 8px; color: #fff; font-size: 13px; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: toastIn 0.3s ease, toastOut 0.3s ease 2.2s forwards; max-width: 320px; }
.toast-success { background: #059669; }
.toast-info { background: #3b82f6; }
.toast-warn { background: #d97706; }
@keyframes toastIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-10px); } }

/* Column Headers */
#col-headers { display: grid; grid-template-columns: minmax(160px, 1fr) minmax(220px, 1.8fr) minmax(280px, 2.5fr); height: var(--colheader-h); background: #e8e8e3; border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 50; }
#col-headers .col-h { display: flex; align-items: center; padding: 0 14px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); border-right: 1px solid var(--border); }
#col-headers .col-h:last-child { border-right: none; }

/* Grid */
#grid-wrap { height: calc(100vh - var(--toolbar-h) - var(--colheader-h)); overflow-y: auto; overflow-x: hidden; }
#grid { display: grid; grid-template-columns: minmax(160px, 1fr) minmax(220px, 1.8fr) minmax(280px, 2.5fr); }

/* Category rows */
.cat-row { grid-column: 1 / -1; padding: 10px 16px; font-size: 13px; font-weight: 700; letter-spacing: 0.02em; color: #fff; display: flex; align-items: center; gap: 8px; position: sticky; top: 0; z-index: 10; }

/* Cells */
.cell { border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); background: var(--surface); position: relative; cursor: text; transition: box-shadow 0.15s; min-height: 120px; max-height: var(--row-h); overflow-y: auto; }
.cell:last-child { border-right: none; }
.cell:hover { box-shadow: inset 0 0 0 2px rgba(59,130,246,0.15); }
.cell.editing { box-shadow: inset 0 0 0 2px var(--border-focus); z-index: 5; }
.cell .display { padding: 10px 14px; font-size: 13px; line-height: 1.55; min-height: 100%; }
.cell .display.title-display { font-weight: 600; font-size: 14px; color: var(--text); }
.cell .display.title-display .num { color: var(--text-muted); font-weight: 400; margin-right: 4px; }
.cell .display ul { padding-left: 18px; margin: 0; }
.cell .display ul li { margin-bottom: 4px; color: #374151; }
.cell .display.raw-display { color: #4b5563; font-size: 12.5px; line-height: 1.6; }
.cell .display.raw-display p { margin-bottom: 8px; }
.cell textarea, .cell input[type="text"] { width: 100%; height: 100%; min-height: 100px; border: none; outline: none; resize: none; font-family: inherit; font-size: 13px; line-height: 1.55; padding: 10px 14px; background: #fefffe; display: none; }
.cell.editing textarea, .cell.editing input[type="text"] { display: block; }
.cell.editing .display { display: none; }
.cell input[type="text"] { font-size: 14px; font-weight: 600; min-height: auto; height: auto; padding: 10px 14px; }
.cell .cat-indicator { position: absolute; left: 0; top: 0; bottom: 0; width: 3px; }

/* History Panel */
#history-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 200; display: none; }
#history-overlay.show { display: block; }
#history-panel { position: fixed; right: 0; top: 0; bottom: 0; width: 380px; background: var(--surface); box-shadow: -4px 0 20px rgba(0,0,0,0.15); z-index: 201; transform: translateX(100%); transition: transform 0.25s ease; display: flex; flex-direction: column; }
#history-panel.show { transform: translateX(0); }
#history-panel .panel-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
#history-panel .panel-header h2 { font-size: 15px; font-weight: 600; }
#history-panel .close-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-muted); padding: 4px 8px; border-radius: 4px; }
#history-panel .close-btn:hover { background: #f3f4f6; }
#history-panel .versions-list { flex: 1; overflow-y: auto; padding: 12px; }
.version-item { padding: 12px 14px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 8px; cursor: default; transition: all 0.15s; }
.version-item:hover { border-color: var(--primary); background: #f0f7ff; }
.version-item.active { border-color: var(--primary); background: #eff6ff; }
.version-item .v-time { font-size: 12px; color: var(--text-muted); }
.version-item .v-label { font-size: 13px; font-weight: 500; margin-top: 2px; }
.version-item .v-changes { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
.version-item .v-actions { margin-top: 8px; display: flex; gap: 6px; }
.version-item .v-actions .btn { font-size: 11px; padding: 4px 10px; }

/* Save Version Modal */
#save-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 300; display: none; align-items: center; justify-content: center; }
#save-modal-overlay.show { display: flex; }
#save-modal { background: var(--surface); border-radius: 12px; padding: 24px; width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
#save-modal h3 { font-size: 16px; margin-bottom: 12px; }
#save-modal input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; outline: none; margin-bottom: 16px; }
#save-modal input:focus { border-color: var(--primary); }
#save-modal .modal-actions { display: flex; justify-content: flex-end; gap: 8px; }

/* Diff highlights */
.cell.diff-changed { background: #fef9c3; }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #aaa; }

/* Search highlight */
.search-hidden { display: none !important; }
</style>
</head>
<body>

<div id="toolbar">
  <h1>Why I Run — Editor</h1>
  <div class="actions">
    <input type="text" id="search-input" placeholder="Search..." />
    <button class="btn btn-primary" id="btn-save">Save Version</button>
    <button class="btn btn-ghost" id="btn-history">History <span class="version-badge" id="version-count">0</span></button>
    <button class="btn btn-ghost" id="btn-export">Export .md</button>
    <span class="version-badge" id="git-status" style="display:none;font-size:10px;">...</span>
  </div>
</div>

<div id="col-headers">
  <div class="col-h">Title</div>
  <div class="col-h">Key Points</div>
  <div class="col-h">Raw Transcript</div>
</div>

<div id="grid-wrap">
  <div id="grid"></div>
</div>

<div id="history-overlay"></div>
<div id="history-panel">
  <div class="panel-header">
    <h2>Version History</h2>
    <button class="close-btn" id="close-history">&times;</button>
  </div>
  <div class="versions-list" id="versions-list"></div>
</div>

<div id="save-modal-overlay">
  <div id="save-modal">
    <h3>Save Version</h3>
    <input type="text" id="version-label" placeholder="Describe your changes..." />
    <div class="modal-actions">
      <button class="btn btn-ghost" id="modal-cancel">Cancel</button>
      <button class="btn btn-primary" id="modal-save">Save</button>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<script>
// ========== TOAST SYSTEM ==========
function showToast(message, type) {
  type = type || 'info';
  var container = document.getElementById('toast-container');
  var toast = document.createElement('div');
  toast.className = 'toast toast-' + type;
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(function() {
    if (toast.parentNode) toast.parentNode.removeChild(toast);
  }, 2600);
}

// ========== STORAGE LAYER ==========
var storageAvailable = false;
var memoryStore = {};

function initStorage() {
  try {
    var testKey = '__storage_test__';
    localStorage.setItem(testKey, 'test');
    localStorage.removeItem(testKey);
    storageAvailable = true;
    console.log('[Editor] localStorage is available');
  } catch(e) {
    storageAvailable = false;
    console.warn('[Editor] localStorage NOT available, using in-memory fallback');
    showToast('Storage limited: changes won\'t persist after reload', 'warn');
  }
}

function storeSet(key, value) {
  var json = JSON.stringify(value);
  if (storageAvailable) {
    try {
      localStorage.setItem(key, json);
    } catch(e) {
      console.error('[Editor] localStorage write failed:', e);
      memoryStore[key] = json;
    }
  } else {
    memoryStore[key] = json;
  }
}

function storeGet(key) {
  var raw;
  if (storageAvailable) {
    raw = localStorage.getItem(key);
  } else {
    raw = memoryStore[key] || null;
  }
  if (raw) {
    try { return JSON.parse(raw); } catch(e) { return null; }
  }
  return null;
}

// ========== CATEGORY COLORS (hex, not CSS vars) ==========
var CAT_COLORS = {
  core: '#3b82f6',
  embodied: '#10b981',
  identity: '#f59e0b',
  meaning: '#8b5cf6',
  personal: '#ef4444',
  emerging: '#06b6d4',
  simulation: '#f97316'
};

var CATEGORIES = [
  { id: 'core', name: 'Core Motivations (Internal / Psychological)' },
  { id: 'embodied', name: 'Embodied & Sensory Motivations' },
  { id: 'identity', name: 'Identity, Play, and Social Dimensions' },
  { id: 'meaning', name: 'Meaning, History, and Ethics' },
  { id: 'personal', name: 'Personal History & Self-Transformation' },
  { id: 'emerging', name: 'Emerging Motivation \u2014 Health and Longevity' },
  { id: 'simulation', name: 'Running as a Simulation of Life Itself' }
];

var INITIAL_REASONS = [
  {
    id: 1, category: 'core',
    title: 'Curiosity About Physical and Mental Limits',
    bullets: [
      'Desire to explore how far, how hard, and how long the body and mind can go',
      'Testing limits of pain, effort, hunger, thirst, sleep, speed, distance',
      'Discovering that the mind gives up long before the body',
      'Fascination with the shifting "I can\'t go on \u2192 I\'m actually fine" transition'
    ],
    rawText: "So definitely one thing that is recurrent is the curiosity of the limits of my body. Meaning, how much can I do? How far can I go? How hard can I push? In terms of effort level, in terms of distance, in terms of speed, in terms of pain, in terms of regret, in terms of food\u2014like hunger, thirst, sleep, and so on. So when you get to a certain level of fitness, when I got\u2014I started to feel very curious about that, like exploring this, because the observation is that once you start, when I started doing harder runs, is that the mind makes me stop way before I need it, way before the body gives up.\n\nSo that raises the question, like, why is that? Like, how is that basically\u2014like a thing that seems synchronized is not at all synchronized? Like, there is an apparent relationship between how much you can take mentally and how much you can take physically, but it's in the\u2014especially in the beginning. Your mind is saying all the time that you should stop with not too much effort, actually. So if you ignore that and keep pushing, you can go way further.\n\nAnd what is very interesting is that at some point, depending on the situation\u2014happened many times with me\u2014the mindset changes. So suddenly I feel like I can't do this anymore. And then I push through, and then I'm like, oh, I actually feel fine. I can go like the same amount of time, even longer, and I don't even know how much longer\u2014can be maybe infinitely longer. That's the feeling. So this is very interesting. And then suddenly you realize that there is a lot of kind of sabotage, which is probably like a protection mechanism that makes you to be like a more safe zone, in terms of how much you can push your body to go."
  },
  {
    id: 2, category: 'core',
    title: 'Cultivation of Fitness to Enable Exploration',
    bullets: [
      'Staying fit as a prerequisite to validly explore limits',
      'Knowing past achievements sets a higher baseline of what\'s possible',
      'Maintaining both physical and mental conditioning to avoid false limits'
    ],
    rawText: "So that's one\u2014definitely one reason. And once you reach\u2014once you do something that you consider hard and you actually reach a very high effort level, then you want to keep fit because, let's say you go and do something that is comparatively, in an objective manner, less hard than something that you have already done. But you feel totally exhausted and like you reached your limit, then I question\u2014I'm like, oh my God, I could do way harder things. I'm just not trained. So that makes me keep wanting to keep a given fitness level that I can always kind of explore more than that, because if I reduce my fitness, this is not going to be actually a valid conclusion, because I know that I can go harder if I am fitter. And not only like physically fit, but mentally fit, because you get used to the kind of training loads, the recovery, and so on. So if you stop doing these things, they become harder, but then you don't discover your limits very much. So that's basically like exploration number one. It's like curiosity, and then to keep\u2014it's like you have to cultivate that physique and fitness level to keep exploring. Otherwise, you basically can't know what you are actually capable of, because you know that you have done harder things in the past."
  },
  {
    id: 3, category: 'core',
    title: 'Feeling Special / Being in the Minority',
    bullets: [
      'Awareness that very few people want or can do this',
      'Feeling different, unique, even "crazy" in a positive way',
      'Enjoying being perceived as extraordinary or impressive'
    ],
    rawText: "Then explanation two. It's kind of linked to that. It's like, actually, not everyone has this mindset. So it's like not everyone wants to explore their limits in an extreme way. And some might want to, but they haven't done it yet, and some don't know that they want to, which is often the case when you begin running. Like, you don't know that you want that. Like, you might not be the source of the reason you started running in the first place, so you might not know. So that is tightly linked, because once you realize that you are like kind of the minority of people, you feel special. Like, I feel special. I feel like, oh my God, I'm doing something that most people don't do, can't do, find it impressive. So it makes me feel powerful. It makes me feel like I'm different, and I differentiate myself from other people in a good way, like I am doing something that is unique and I'm pushing my limits in a way that I'm getting this feeling that not everyone has. So it's like a bit of a feeling of being special.\n\nTied to that is also\u2014you want to keep doing it, because you want to keep exploring, talking to people. I want to, like, find more and more. Like, I have people who\u2014sometimes I like the idea that I'm being considered unique or crazy or whatever related."
  },
  {
    id: 4, category: 'core',
    title: 'Pride, Confidence, and Personal Empowerment',
    bullets: [
      'Deep pride after completing extremely hard efforts',
      'Carryover confidence into everyday life',
      'Knowing you\'ve done something harder than most people can imagine',
      'A "secret strength" that stabilizes self-esteem'
    ],
    rawText: "Explanation number three\u2014it's linked to that. It's like, let's say you do something that is very hard, and I feel like when I accomplish something like that, I get extremely proud of myself. I feel powerful, I feel limitless, I feel like I can do anything I want. And that's partially because very few people would be able to do that. So after running, like, for ten hours in a row, finishing a race strong, going back home destroyed, but then waking up way more recovered and just going about my life, to work normally\u2014it's like people have no idea what I just did. So it feels extremely special. I feel more confident in my life overall, and that basically prepares me for moments that I would normally feel insecure. I feel secure about it because I know I did something way harder. That is a bit of a secret to most people."
  },
  {
    id: 5, category: 'core',
    title: 'Competitiveness (Internal and External)',
    bullets: [
      'Desire to improve on previous performances',
      'Drive to race well, place, podium, or win',
      'Strategic thinking about performance optimization'
    ],
    rawText: "Explanation number four is related to competitiveness, which is tightly related to this one. It's like, \"Oh, I did it better than last time\" for myself. But then, once you get to a certain level\u2014I got to a certain level\u2014that I actually became somehow competitive in some races. I like\u2014I want to beat that. I want to, like, be on the podium. I'm gonna win this. And I think I can do it if I do it this way. So, like, explanation 4 is related to competitiveness."
  },
  {
    id: 6, category: 'embodied',
    title: 'Connection to Nature as a Natural Human State',
    bullets: [
      'Running as the most "natural" human movement',
      'Feeling evolutionarily aligned as a Homo sapiens',
      'Preference over cycling, skiing, swimming'
    ],
    rawText: "Now, um there all people can do all sorts of stuff to feed one, two, three, and four. Why did I choose endurance especially ultra running, especially trail running, is because I love nature. I love to be outside. I love to be in the mountains. I love to connect with the nature is the time that I feel mostly natural connected to my environment if you so natural it's like the best place to be. It's so evolutionarily the case. I mean, you are like outside, you are free. It's not like cycling. It's not like skiing. It's not like swimming. It's my natural environment as a homo sapiens. Feels like extremely natural."
  },
  {
    id: 7, category: 'embodied',
    title: 'Deep Sensory Immersion in the Environment',
    bullets: [
      'Love of mountains, sea, animals, plants',
      'Enjoying smells, textures, sounds, mud, rain, water',
      'Feeling fully embedded in the landscape',
      'Longing to live in nature rather than return home'
    ],
    rawText: "The develop of nature I love the mountain. I love the sea. I love the animals. I love the plants, the fi. Everything about it. I observe, I feel I feel like a sense, the smell I touch, I love the smells so I love the touch. Of trees, I love the the sounds. My feet on the ground, the water flowing, the rain, I love the mud. I love to have my body connected to that environment. If it a natural when I come back home, like, I wish I just lived out there. And that might be something that I'm gonna pursue more and more."
  },
  {
    id: 8, category: 'embodied',
    title: 'Pleasure, Euphoria, and Reward',
    bullets: [
      'Endorphins and runner\'s high',
      'Heightened pleasure after deprivation (water, food, warmth)',
      'Contrast-based enjoyment (cold \u2192 hot shower, hunger \u2192 food)'
    ],
    rawText: "Inspiration number seven, maybe it's related to pleasure. It's like, of course, running, and exercising hard gives gives me a lot of pleasure, I feel like euphoric. If you relaxed after I shower, hot shower, after a cold run, or incredibly good. There is like a also society, like being thirsty and then drinking water, electrolytes, being hungry, and then eating something after the run, all of these tastes better. They the drinks, taste better and a lot of pleasure."
  },
  {
    id: 9, category: 'embodied',
    title: 'Meditative Focus and Mental Clarity',
    bullets: [
      'Entering a deeply focused, present state',
      'External worries recede as terrain and effort demand attention',
      'Harder and more technical terrain increases mental stillness'
    ],
    rawText: "Explanation number nine. It's similar. It's like, there's a meditative state. It puts me in a place that I feel concentrated, and um everything else, kind of get a second place, like, that's happening in my life. It's a time for myself with myself that the harder it is, the more technical the terrain is, the more challenging it is, the more I have to focus and therefore, less space I have in my mind for the external world, other things work, and so on, so forth."
  },
  {
    id: 10, category: 'embodied',
    title: 'Pleasure in Pain, Suffering, and Uncertainty',
    bullets: [
      'Enjoyment of prolonged discomfort and fear',
      'Masochistic component acknowledged without judgment',
      'Pain as a mechanism that collapses thought into pure presence'
    ],
    rawText: "Her explanation, now eight or nine, I'm not sure, is probably related to, to that, but in a bit darker way, it's the the pleasure of the pain, of suffering, the pleasure of actual feeling pain for a long period of time, and the pleasure of feeling fear and uncertainty for a long time. That's a bit harder to explain because this is very real, but at the same time, it's like. is it bad to feel this way? Like, is it like, um, kind of wrong to feel this way? So, I by talking about it and admitting that, it's making me it easier for me to do that. It's definitely. There is definitely a pleasure on that. And I think that's connected to the explanation before. We made meditation or easiness of stuff like when you have so much pain, that every step it hurts, you can't think about anything else. I mean, you just have to keep moving. You're thinking about your body and so on. So there is definitely a component of a bit of masochism."
  },
  {
    id: 11, category: 'embodied',
    title: 'Deepened Connection With the Body',
    bullets: [
      'Learning anatomy, pain types, physiology',
      'Awareness of muscles, tendons, organs, limits',
      'Rediscovering bodily intelligence lost in adulthood'
    ],
    rawText: "And that relates to explanation number ten, which is connection with my body. Like, before running, I had no idea about my body\u2014my body parts, the types of pain that exist, if it's muscle pain, if it's tendon pain, where my organs were, where my muscles were, where the bones, the ligaments, the retinaculum\u2014any of that. Like, I had no idea. So as much as running is a journey to discover the outside world, it is the same to discover the mind, or like my mind, and my body\u2014like all the parts, how they function, the physiology, and so on. So running connected me way more to my body. So that's definitely something that we lose, or something I lost as I grew up, for several reasons."
  },
  {
    id: 12, category: 'identity',
    title: 'Playfulness and Childlike Joy',
    bullets: [
      'Running as play rather than labor',
      'Downhill running as a game',
      'Joy in mud, rain, silliness, jumping, posing',
      'Reconnection with childhood embodiment'
    ],
    rawText: "So I feel like one of the big, big explanations is the playfulness. Like, when I was a kid, I was more connected to my body, I was more connected to nature. Running is playing. Like, when I run downhill, I feel like I'm playing a video game, almost\u2014like a game that I have to deviate, I have to jump. If I fall, I have to, like, get back on my feet. There is speed, adrenaline. I love when it's raining and there is mud, because then there are puddles and the splashes of water, splashes of mud. So it brings me back to a more natural, child state of enjoyment, of silliness. I see very often, like, when I'm running on my trails, that we do some silly things, pose for photos in a silly way. We do, like, little jumps, we smile at each other and perform."
  },
  {
    id: 13, category: 'identity',
    title: 'Social Bonding Through Shared Hardship',
    bullets: [
      'Training and racing as deeply social experiences',
      'Bonding through pain, effort, and altered states',
      'Strong friendships built through shared adversity'
    ],
    rawText: "So that leads to explanation number twelve, which is the social aspect of running. People think running is an individual sport, but running is not at all an individual sport. It's a team sport. And training\u2014it is a lot\u2014a very powerful way. Training together is a very powerful way to make friendships, because you are sharing\u2014like, I feel like I'm sharing these moments with people that I like. And these are hard moments, so it's like bonding through pain, bonding through effort, and enjoying\u2014like, having the same trip, like being stoned together by endorphins and adrenaline, and sharing that moment in a very raw way, and then carrying all of these other explanations, all of the accomplishments, all of the pride, and so on, with other people."
  },
  {
    id: 14, category: 'identity',
    title: 'Team and Support Ecosystem',
    bullets: [
      'Coaches, teammates, crew, pacers',
      'Physical therapists, medical professionals',
      'Collective preparation and shared goals'
    ],
    rawText: "So there is this in training, in racing. It's also in training. It's also beyond that. It's like the community, the coach, the team of people that you are working with, with the physical therapist, if it's an orthopedic surgeon, your, let's say, your run club, and so on. You know, reading about running\u2014all of this is a very, very social and meaningful connection experience.\n\nThen there is the racing part that is also extremely social, which is your crew members, like people that I love and care about. They go and help me doing this, run these races. There is a whole help related to me\u2014pacing and then crewing and preparing to the moment. All of this is an additional sharing with people that I love and care about."
  },
  {
    id: 15, category: 'identity',
    title: 'Community and Belonging',
    bullets: [
      'Local clubs, race communities, shared culture',
      'Long-term relationships (e.g., Golden Gate Trail Run Club)',
      'Shared adventures and spontaneous commitment'
    ],
    rawText: "And it's to the next explanation, which is basically more the community of it. So running is not only social for you, but it's like there is a whole community around it. And the community can be your local running club, it can be, let's say, like, a race series. It can be, yeah, the more global\u2014thinking about sharing something that is good for you, like the whole relationship with nature, environment, and so on. So, yeah, definitely this is one of the biggest things that I discovered with my running community, especially now the Golden Gate Trail Run Club for me\u2014years and all the friends, all the adventures we did together to the Grand Canyon, Yosemite, all the adventures here in San Francisco, around here, like running from home to Stinson Beach, running from home to the top of Mount Tam. Yeah. Having people that I can just call, like, the night before, and they will be willing to go on an adventure like that with me for hours and hours and so on. The community is, like, an incredible reason as well."
  },
  {
    id: 16, category: 'meaning',
    title: 'Connection to Place and Land',
    bullets: [
      'Running as a way to understand where you live',
      'Deepened awareness of ecosystems and human impact'
    ],
    rawText: "And then the community also leads to, like, okay, what are we doing here? So there is, like, a whole other part of the community that is the connection with where we are. What is this land? What is the nature around here? How are my actions affecting it? I love it so much that I started to think\u2014I love nature so much, and these mountains, and this region so much\u2014that I started to think more about it."
  },
  {
    id: 17, category: 'meaning',
    title: 'Environmental Awareness and Responsibility',
    bullets: [
      'Heightened sensitivity to environmental destruction',
      'Stronger emotional reaction to mining, exploitation, degradation',
      'Desire to protect what you love'
    ],
    rawText: "Like, what are the effects of, like, especially, for example, in my country, like Minas in Brazil, and mines around Belo Horizonte, and all of the mining activity. I had a totally different, like way more intense aversion to all of that, because of what happened, what happens with the environment.\n\nAnd I started to have this feeling when we moved to the Bay Area, but more intensely when I started to photograph the life and the garden of the house, that I really started to research and pay attention to that, and the effects of, like, human interventions. And this last time that I went to Brazil, I felt it a lot stronger\u2014like, what a pity, like, how bad."
  },
  {
    id: 18, category: 'meaning',
    title: 'Historical and Cultural Reflection',
    bullets: [
      'Awareness of colonial history, slavery, land exploitation',
      'Comparing Brazil and California\'s gold histories',
      'Running as a portal into historical consciousness'
    ],
    rawText: "And then I started to think about the whole environmental aspect, but then the whole historical aspect of it\u2014of how gold was exploited historically in that region, how much that was different compared with California. Because differently from California, the gold in Brazil, in Minas specifically, was discovered by the Portuguese during colonial times. So how the gold flowed, was transported from Brazil to Europe\u2014so nothing stayed there. Whereas in California, the gold was discovered way later, after the country was independent, which means that the gold stayed here and fueled all of the innovation and so on.\n\nOn top of that, all the gold extraction in Brazil was done by slaves, and that shaped the whole society. And here that was not the case. So this is just an example of how running can bring you to history as well, the past, by running on these lands that once were native territory, like here, and then they got totally exploited by colonization. It makes me realize the depth of the historical context, geographical context that I live in."
  },
  {
    id: 19, category: 'personal',
    title: 'Self-Exploration and Identity Inquiry',
    bullets: [
      'Questioning motives: "What am I proving, and to whom?"',
      'Running as a mirror into deeper psychological patterns'
    ],
    rawText: "And then there is probably another explanation that now I lost the count, but it's related to my own story. So it makes me realize more about myself as well\u2014like, why am I doing this? Like, why am I doing these things that are so hard? What am I trying to prove, to whom?"
  },
  {
    id: 20, category: 'personal',
    title: 'Healing Insecurity and Fear From Early Life',
    bullets: [
      'Addressing long-standing insecurity about body and ability',
      'Shifting from purely intellectual identity to embodied competence'
    ],
    rawText: "And that brings me back to maybe the hardest explanation to talk about, which is me growing up and feeling myself insecure in so many ways, afraid in so many ways, probably because of how I was raised. And then, really not comfortable with my body, not comfortable with my skills. Not, yeah, comfortable with what I could do, what people saw in me. And I approached this in a way that it started with intellect. So I discovered early that I had some advantages on the intellectual part compared to my colleagues. In the musical part as well. So I exploited that for most of my life. I went and studied hard, did a PhD, became a scientist. But I was lacking the other aspect, which was the physical one, and that took me a while, because I didn't know I had any advantage in that."
  },
  {
    id: 21, category: 'personal',
    title: 'Discovering Physical Talent and Capability',
    bullets: [
      'Realizing natural strengths (especially uphill running)',
      'Redefining self-image relative to others',
      'Proving to yourself that you can do the hardest things'
    ],
    rawText: "But then, when I discovered running, I discovered that\u2014especially\u2014I discovered that I have some advantages and kind of an easiness to run uphill. My body is slim, and I have, like, strong legs, so I had not too much trouble in becoming good at running uphill. So, yeah, I'm sure that there's a lot in this journey that ties back to my earlier experiences of insecurity and fear, and proving to myself now that I can do anything. I can do the hardest things\u2014things that I only considered that some way stronger people than me could do. Some of my friends that looked stronger, and now I'm like, they would never be able to do something like that. Of course, if they trained, everyone would be able to, but at their current state, they would not. And so definitely that place is a big, big growth as well."
  },
  {
    id: 22, category: 'emerging',
    title: 'Health, Longevity, and Sustainability (Emerging)',
    bullets: [
      'Acknowledged as less central historically',
      'Growing concern with aging, injury prevention, longevity',
      'Hiring a coach to train responsibly and sustainably'
    ],
    rawText: "So I guess that's it. I guess it's a comprehensive list of explanations of why I run, how much running is important in my life. And the funny thing is that I didn't think much to say, and probably because this really plays a minor role, which is fitness level and, like, longevity. I don't think I run to get fit, to be healthy, to be honest. I do think I run a bit better, but I don't think I have too much of a reason that is related to actual health. And that's something that is kind of starting to bother me a little bit, and I think I should have more of that.\n\nAnd I think that's going to help in running in any direction, even for performance. Like, if I introduce that kind of reason more explicitly\u2014one is that it is making me very healthy, and it can make me very healthy if done in a responsible way. So I think that's why I hired a coach, working with a coach now, because I'm thinking more about longevity, getting older and wanting to train properly, preventing injury, because repeated injury is the strongest prediction of detrimental effects in the long term. So the best way to prevent injury is, of course, to train smart, and the best way to train smart is to be trained\u2014to be coached\u2014by an experienced coach."
  },
  {
    id: 24, category: 'simulation',
    title: 'Simulation of Life Itself',
    bullets: [
      'Running and racing as a metaphor for the full life cycle: beginning, growth, crisis, decline, resolution, and rebirth',
      'Each run reproduces life at a compressed timescale',
      'Pain, fear, and exhaustion are phases, not endpoints',
      'Strong pain does not mean the race is over; everything passes',
      'Success depends on continuous problem-solving under uncertainty',
      'Solutions are often counterintuitive',
      'Learning to adapt rather than panic',
      'Training trust in impermanence, resilience, and creativity in adversity'
    ],
    rawText: "I have 2 extra to add. 1. simulation of life itself. like the from birth to death and rebirth like a metaphor for life itself daily, problem solving during races. strong pain does not mean race is over, everything passes, you just need to find the solution. sometimes it is very counterintuitive. like cultivating a cramp pain to distract from a higher pain."
  },
  {
    id: 25, category: 'simulation',
    title: 'Trajectories, Navigation, and the Beauty of Routes',
    bullets: [
      'Fascination with paths, routes, and movement through space',
      'Meaning in trajectories with a clear beginning, middle, and end',
      'Appreciation for loops, out-and-back routes, traverses, and point-to-point journeys',
      'Navigation as both a cognitive and aesthetic experience',
      'The route itself as the objective, not just the outcome',
      'Satisfaction in linking landscapes coherently over time',
      'Running as exploration shaped by geography, choice, and flow'
    ],
    rawText: "2. trajectories, navigation, fascination with routes, beginning to the end, loops, the beauty of the path."
  }
];

// ========== STATE ==========
var reasons = [];
var versions = [];
var editingCell = null;
var dirty = false;
var previewVersionId = null;

var STORAGE_KEY = 'whyirun_data';
var VERSIONS_KEY = 'whyirun_versions';

function deepClone(obj) { return JSON.parse(JSON.stringify(obj)); }

// ========== SERVER API ==========
var useServer = false; // auto-detected

function apiUrl(path) { return path; } // relative URLs when served by server

function serverSave(reasons, message) {
  if (!useServer) return;
  fetch('/api/save', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ reasons: reasons, message: message || '' })
  }).then(function(r) { return r.json(); }).then(function(data) {
    if (data.ok) {
      console.log('[Server] Saved to file + git commit');
      updateGitStatus();
    } else {
      console.error('[Server] Save error:', data.error);
    }
  }).catch(function(e) {
    console.warn('[Server] Save failed (offline?):', e.message);
  });
}

function serverSaveVersion(reasons, label) {
  if (!useServer) return;
  fetch('/api/version', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ reasons: reasons, label: label })
  }).then(function(r) { return r.json(); }).then(function(data) {
    if (data.ok) {
      console.log('[Server] Version saved to git');
      updateGitStatus();
    }
  }).catch(function(e) {
    console.warn('[Server] Version save failed:', e.message);
  });
}

function updateGitStatus() {
  if (!useServer) return;
  fetch('/api/status').then(function(r) { return r.json(); }).then(function(data) {
    if (data.ok) {
      var badge = document.getElementById('git-status');
      if (badge) {
        if (!data.hasRemote) {
          badge.textContent = 'no remote';
          badge.style.background = '#92400e';
        } else if (data.pushPending) {
          badge.textContent = 'pushing...';
          badge.style.background = '#d97706';
        } else {
          badge.textContent = 'synced';
          badge.style.background = '#059669';
        }
        badge.style.display = 'inline-block';
      }
      // Update git commit count
      var gitCount = document.getElementById('git-commit-count');
      if (gitCount && data.commits) {
        gitCount.textContent = data.commits.length + ' commits';
      }
    }
  }).catch(function() {});
}

function detectServer() {
  return fetch('/api/status').then(function(r) { return r.json(); }).then(function(data) {
    if (data.ok) {
      useServer = true;
      console.log('[Editor] Server detected — git auto-push enabled');
      return true;
    }
    return false;
  }).catch(function() {
    useServer = false;
    console.log('[Editor] No server — using local storage only');
    return false;
  });
}

function serverLoadData() {
  return fetch('/api/data').then(function(r) { return r.json(); }).then(function(data) {
    if (data.ok && data.data && Array.isArray(data.data) && data.data.length > 0) {
      return data.data;
    }
    return null;
  }).catch(function() { return null; });
}

// ========== LOAD / SAVE ==========
function loadState(callback) {
  // Try server first, fall back to localStorage
  function finishLoad(serverData) {
    if (serverData && Array.isArray(serverData) && serverData.length > 0) {
      reasons = serverData;
      console.log('[Editor] Loaded', reasons.length, 'reasons from server');
    } else {
      var saved = storeGet(STORAGE_KEY);
      if (saved && Array.isArray(saved) && saved.length > 0) {
        reasons = saved;
        console.log('[Editor] Loaded', reasons.length, 'reasons from localStorage');
      } else {
        reasons = deepClone(INITIAL_REASONS);
        console.log('[Editor] Using initial data:', reasons.length, 'reasons');
      }
    }

    var savedVersions = storeGet(VERSIONS_KEY);
    if (savedVersions && Array.isArray(savedVersions) && savedVersions.length > 0) {
      versions = savedVersions;
    } else {
      versions = [];
    }

    if (versions.length === 0) {
      var initialVersion = {
        id: String(Date.now()),
        timestamp: Date.now(),
        label: 'Initial version',
        data: deepClone(INITIAL_REASONS)
      };
      versions.push(initialVersion);
      storeSet(VERSIONS_KEY, versions);
    }

    updateVersionCount();
    if (callback) callback();
  }

  if (useServer) {
    serverLoadData().then(function(data) { finishLoad(data); });
  } else {
    finishLoad(null);
  }
}

function autoSave() {
  storeSet(STORAGE_KEY, reasons);
  serverSave(reasons);
  console.log('[Editor] Auto-saved');
}

function saveVersion(label) {
  var v = {
    id: String(Date.now()),
    timestamp: Date.now(),
    label: label || 'Untitled save',
    data: deepClone(reasons)
  };
  versions.push(v);
  storeSet(VERSIONS_KEY, versions);
  dirty = false;
  updateVersionCount();

  // Also save to server with explicit version label
  serverSaveVersion(reasons, v.label);

  showToast('Version saved: ' + v.label, 'success');
  console.log('[Editor] Saved version:', v.label, '| Total versions:', versions.length);
}

function restoreVersion(versionId) {
  var v = null;
  for (var i = 0; i < versions.length; i++) {
    if (versions[i].id === versionId) { v = versions[i]; break; }
  }
  if (!v) { showToast('Version not found', 'warn'); return; }
  reasons = deepClone(v.data);
  autoSave();
  dirty = false;
  previewVersionId = null;
  renderGrid();
  showToast('Restored: ' + v.label, 'info');
  console.log('[Editor] Restored version:', v.label);
}

function updateVersionCount() {
  var badge = document.getElementById('version-count');
  if (badge) badge.textContent = String(versions.length);
}

// ========== RENDERING ==========
function getCatColor(catId) { return CAT_COLORS[catId] || '#888'; }
function getCatName(catId) {
  for (var i = 0; i < CATEGORIES.length; i++) {
    if (CATEGORIES[i].id === catId) return CATEGORIES[i].name;
  }
  return '';
}

function escapeHtml(str) {
  var div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function renderGrid() {
  var grid = document.getElementById('grid');
  grid.innerHTML = '';
  var query = document.getElementById('search-input').value.toLowerCase().trim();

  var currentCat = null;
  for (var ri = 0; ri < reasons.length; ri++) {
    var r = reasons[ri];
    var searchable = (r.title + ' ' + r.bullets.join(' ') + ' ' + r.rawText).toLowerCase();
    var hidden = query && searchable.indexOf(query) === -1;

    if (r.category !== currentCat) {
      currentCat = r.category;
      var catRow = document.createElement('div');
      catRow.className = 'cat-row' + (hidden ? ' search-hidden' : '');
      catRow.setAttribute('data-cat', r.category);
      catRow.style.backgroundColor = getCatColor(r.category);
      catRow.textContent = getCatName(r.category);
      grid.appendChild(catRow);
    }

    if (!hidden) {
      var catRows = grid.querySelectorAll('.cat-row[data-cat="' + r.category + '"]');
      for (var ci = 0; ci < catRows.length; ci++) catRows[ci].classList.remove('search-hidden');
    }

    grid.appendChild(createCell(r, 'title', hidden));
    grid.appendChild(createCell(r, 'bullets', hidden));
    grid.appendChild(createCell(r, 'rawText', hidden));
  }
}

function createCell(reason, field, hidden) {
  var cell = document.createElement('div');
  cell.className = 'cell' + (hidden ? ' search-hidden' : '');
  cell.setAttribute('data-id', String(reason.id));
  cell.setAttribute('data-field', field);

  if (field === 'title') {
    var indicator = document.createElement('div');
    indicator.className = 'cat-indicator';
    indicator.style.backgroundColor = getCatColor(reason.category);
    cell.appendChild(indicator);
  }

  // Diff highlight
  if (previewVersionId) {
    var pv = null;
    for (var i = 0; i < versions.length; i++) {
      if (versions[i].id === previewVersionId) { pv = versions[i]; break; }
    }
    if (pv) {
      var pvReason = null;
      for (var j = 0; j < pv.data.length; j++) {
        if (pv.data[j].id === reason.id) { pvReason = pv.data[j]; break; }
      }
      if (pvReason) {
        var curr = field === 'bullets' ? reason.bullets.join('\n') : reason[field];
        var prev = field === 'bullets' ? pvReason.bullets.join('\n') : pvReason[field];
        if (curr !== prev) cell.classList.add('diff-changed');
      }
    }
  }

  // Display div
  var display = document.createElement('div');
  display.className = 'display';

  if (field === 'title') {
    display.classList.add('title-display');
    display.innerHTML = '<span class="num">' + reason.id + '.</span> ' + escapeHtml(reason.title);
  } else if (field === 'bullets') {
    var html = '<ul>';
    for (var bi = 0; bi < reason.bullets.length; bi++) {
      html += '<li>' + escapeHtml(reason.bullets[bi]) + '</li>';
    }
    html += '</ul>';
    display.innerHTML = html;
  } else {
    display.classList.add('raw-display');
    var paragraphs = reason.rawText.split('\n\n');
    var phtml = '';
    for (var pi = 0; pi < paragraphs.length; pi++) {
      phtml += '<p>' + escapeHtml(paragraphs[pi]) + '</p>';
    }
    display.innerHTML = phtml;
  }
  cell.appendChild(display);

  // Edit input
  var editEl;
  if (field === 'title') {
    editEl = document.createElement('input');
    editEl.type = 'text';
    editEl.value = reason.title;
  } else {
    editEl = document.createElement('textarea');
    editEl.value = field === 'bullets' ? reason.bullets.join('\n') : reason.rawText;
  }

  // Use closures to capture reason.id and field
  (function(rid, f, el) {
    el.addEventListener('blur', function() {
      finishEdit(rid, f, el.value);
    });
    el.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') cancelEdit();
      if (e.key === 'Enter' && f === 'title') el.blur();
    });
    if (el.tagName === 'TEXTAREA') {
      el.addEventListener('input', function() { autoResizeTextarea(el); });
    }
  })(reason.id, field, editEl);

  cell.appendChild(editEl);

  // Click display to start editing
  (function(c, rid, f) {
    display.addEventListener('click', function() {
      startEdit(c, rid, f);
    });
  })(cell, reason.id, field);

  return cell;
}

function autoResizeTextarea(ta) {
  ta.style.height = 'auto';
  ta.style.height = Math.max(ta.scrollHeight, 100) + 'px';
}

function startEdit(cell, reasonId, field) {
  if (editingCell) {
    var prev = document.querySelector('.cell.editing');
    if (prev) {
      var prevInput = prev.querySelector('textarea') || prev.querySelector('input[type="text"]');
      if (prevInput) prevInput.blur();
    }
  }
  cell.classList.add('editing');
  editingCell = { reasonId: reasonId, field: field };
  var input = cell.querySelector('textarea') || cell.querySelector('input[type="text"]');
  if (input) {
    setTimeout(function() {
      input.focus();
      if (input.tagName === 'TEXTAREA') autoResizeTextarea(input);
    }, 20);
  }
}

function finishEdit(reasonId, field, value) {
  var r = null;
  for (var i = 0; i < reasons.length; i++) {
    if (reasons[i].id === reasonId) { r = reasons[i]; break; }
  }
  if (!r) return;

  var changed = false;
  if (field === 'title' && r.title !== value) {
    r.title = value;
    changed = true;
  } else if (field === 'bullets') {
    var newBullets = value.split('\n').map(function(l) {
      return l.replace(/^[\s\-\u2022*]+/, '').trim();
    }).filter(function(x) { return x.length > 0; });
    if (JSON.stringify(r.bullets) !== JSON.stringify(newBullets)) {
      r.bullets = newBullets;
      changed = true;
    }
  } else if (field === 'rawText' && r.rawText !== value) {
    r.rawText = value;
    changed = true;
  }

  if (changed) {
    dirty = true;
    autoSave();
  }

  editingCell = null;
  renderGrid();
}

function cancelEdit() {
  editingCell = null;
  renderGrid();
}

// ========== VERSION HISTORY ==========
function toggleHistory() {
  var panel = document.getElementById('history-panel');
  var overlay = document.getElementById('history-overlay');
  var showing = !panel.classList.contains('show');
  if (showing) {
    panel.classList.add('show');
    overlay.classList.add('show');
    renderVersionsList();
  } else {
    panel.classList.remove('show');
    overlay.classList.remove('show');
    previewVersionId = null;
    renderGrid();
  }
}

function renderVersionsList() {
  var list = document.getElementById('versions-list');
  list.innerHTML = '';

  if (versions.length === 0) {
    list.innerHTML = '<p style="color:#999;padding:20px;text-align:center;">No versions yet. Click "Save Version" to create one.</p>';
    return;
  }

  // Show newest first
  for (var i = versions.length - 1; i >= 0; i--) {
    var v = versions[i];
    var item = document.createElement('div');
    item.className = 'version-item' + (previewVersionId === v.id ? ' active' : '');

    var time = new Date(v.timestamp);
    var timeStr = time.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ', ' +
                  time.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

    var changeCount = 0;
    for (var j = 0; j < v.data.length; j++) {
      var vr = v.data[j];
      var cr = null;
      for (var k = 0; k < reasons.length; k++) {
        if (reasons[k].id === vr.id) { cr = reasons[k]; break; }
      }
      if (cr) {
        if (cr.title !== vr.title) changeCount++;
        if (JSON.stringify(cr.bullets) !== JSON.stringify(vr.bullets)) changeCount++;
        if (cr.rawText !== vr.rawText) changeCount++;
      }
    }

    var timeDiv = document.createElement('div');
    timeDiv.className = 'v-time';
    timeDiv.textContent = timeStr;
    item.appendChild(timeDiv);

    var labelDiv = document.createElement('div');
    labelDiv.className = 'v-label';
    labelDiv.textContent = v.label;
    item.appendChild(labelDiv);

    var changesDiv = document.createElement('div');
    changesDiv.className = 'v-changes';
    changesDiv.textContent = changeCount === 0 ? 'Matches current' : changeCount + ' cell(s) differ from current';
    item.appendChild(changesDiv);

    var actionsDiv = document.createElement('div');
    actionsDiv.className = 'v-actions';

    var previewBtn = document.createElement('button');
    previewBtn.className = 'btn btn-ghost';
    previewBtn.textContent = 'Preview Diff';
    (function(vid) {
      previewBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        previewVersionId = (previewVersionId === vid) ? null : vid;
        renderGrid();
        renderVersionsList();
      });
    })(v.id);
    actionsDiv.appendChild(previewBtn);

    var restoreBtn = document.createElement('button');
    restoreBtn.className = 'btn btn-danger';
    restoreBtn.textContent = 'Restore';
    (function(vid) {
      restoreBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (confirm('Restore this version? Current unsaved edits will be lost.')) {
          restoreVersion(vid);
          toggleHistory();
        }
      });
    })(v.id);
    actionsDiv.appendChild(restoreBtn);

    item.appendChild(actionsDiv);
    list.appendChild(item);
  }
}

// ========== SAVE MODAL ==========
function openSaveModal() {
  var overlay = document.getElementById('save-modal-overlay');
  overlay.classList.add('show');
  var input = document.getElementById('version-label');
  input.value = '';
  setTimeout(function() { input.focus(); }, 100);
}

function closeSaveModal() {
  document.getElementById('save-modal-overlay').classList.remove('show');
}

function doSaveVersion() {
  var label = document.getElementById('version-label').value.trim() || 'Untitled save';
  saveVersion(label);
  closeSaveModal();
  renderGrid();
}

// ========== EXPORT ==========
function exportMarkdown() {
  var md = '# Why I Run\n\n';
  var currentCat = null;

  for (var i = 0; i < reasons.length; i++) {
    var r = reasons[i];
    if (r.category !== currentCat) {
      currentCat = r.category;
      md += '---\n\n## ' + getCatName(r.category) + '\n\n';
    }
    md += '### ' + r.id + '. ' + r.title + '\n\n';
    for (var b = 0; b < r.bullets.length; b++) {
      md += '- ' + r.bullets[b] + '\n';
    }
    md += '\n';
    md += '> ' + r.rawText.split('\n\n').join('\n>\n> ') + '\n\n';
  }

  var blob = new Blob([md], { type: 'text/markdown' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'why_I_run_export.md';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast('Exported markdown file', 'success');
}

// ========== EVENT LISTENERS ==========
document.getElementById('btn-save').addEventListener('click', function() {
  openSaveModal();
});

document.getElementById('btn-history').addEventListener('click', function() {
  toggleHistory();
});

document.getElementById('btn-export').addEventListener('click', function() {
  exportMarkdown();
});

document.getElementById('history-overlay').addEventListener('click', function() {
  toggleHistory();
});

document.getElementById('close-history').addEventListener('click', function() {
  toggleHistory();
});

document.getElementById('modal-cancel').addEventListener('click', function() {
  closeSaveModal();
});

document.getElementById('modal-save').addEventListener('click', function() {
  doSaveVersion();
});

document.getElementById('save-modal-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeSaveModal();
});

document.getElementById('save-modal').addEventListener('click', function(e) {
  e.stopPropagation();
});

document.getElementById('version-label').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') doSaveVersion();
  if (e.key === 'Escape') closeSaveModal();
});

document.getElementById('search-input').addEventListener('input', function() {
  renderGrid();
});

document.addEventListener('keydown', function(e) {
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    openSaveModal();
  }
});

// Warn before leaving with unsaved changes
window.addEventListener('beforeunload', function(e) {
  if (dirty) {
    e.preventDefault();
    e.returnValue = '';
  }
});

// ========== INIT ==========
function init() {
  console.log('[Editor] Initializing...');
  initStorage();

  // Detect server, then load data
  detectServer().then(function(hasServer) {
    loadState(function() {
      renderGrid();
      var msg = 'Editor loaded \u2014 ' + reasons.length + ' reasons';
      if (hasServer) {
        msg += ' (git auto-push enabled)';
        updateGitStatus();
        // Poll git status every 15 seconds
        setInterval(updateGitStatus, 15000);
      }
      showToast(msg, 'info');
      console.log('[Editor] Ready!');
    });
  });
}

init();
</script>
</body>
</html>
